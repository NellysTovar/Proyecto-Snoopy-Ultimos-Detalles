<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Resultados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 3px solid #5852CB; color: #5852CB; font-weight: bold; }
        .hidden-section { display: none !important; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="window.history.back()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-arrow-left"></i></button>
            <h1 class="text-xl font-bold text-gray-800">Centro de Reportes</h1>
        </div>
        <div class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded uppercase tracking-wider" id="userRoleDisplay">...</div>
    </header>

    <main class="flex-1 overflow-y-auto p-6">
        
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-end transition-all" id="filtrosGlobales">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Evento</label>
                <select id="selectEvento" class="border rounded p-2 w-64 bg-gray-50 text-sm focus:ring-2 focus:ring-[#5852CB] outline-none"></select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categor√≠a</label>
                <select id="selectCategoria" class="border rounded p-2 w-64 bg-gray-50 text-sm focus:ring-2 focus:ring-[#5852CB] outline-none"></select>
            </div>
            <button onclick="cargarReporteActual()" class="bg-[#5852CB] text-white px-6 py-2 rounded hover:bg-[#4c46b6] font-bold text-sm shadow">
                <i class="fa-solid fa-magnifying-glass mr-2"></i> Consultar
            </button>
        </div>

        <div class="flex border-b border-gray-200 mb-6 space-x-6 overflow-x-auto" id="tabsContainer">
            <button onclick="switchTab('top3')" class="pb-2 text-gray-500 hover:text-[#5852CB] tab-btn hidden-section role-admin" id="tab-top3">
                <i class="fa-solid fa-medal mr-1"></i> Top 3
            </button>
            <button onclick="switchTab('equipos')" class="pb-2 text-gray-500 hover:text-[#5852CB] tab-btn hidden-section role-admin" id="tab-equipos">
                <i class="fa-solid fa-list mr-1"></i> Participantes
            </button>
            <button onclick="switchTab('stats')" class="pb-2 text-gray-500 hover:text-[#5852CB] tab-btn hidden-section role-admin" id="tab-stats">
                <i class="fa-solid fa-chart-pie mr-1"></i> Estad√≠sticas
            </button>
            
            <button onclick="switchTab('global')" class="pb-2 text-gray-500 hover:text-[#5852CB] tab-btn" id="tab-global">
                <i class="fa-solid fa-table mr-1"></i> Tabla Global
            </button>
            
            <button onclick="switchTab('detalle')" class="pb-2 text-gray-500 hover:text-[#5852CB] tab-btn hidden-section role-coach" id="tab-detalle">
                <i class="fa-solid fa-clipboard-check mr-1"></i> Mi Desglose
            </button>
        </div>

        <div id="view-top3" class="report-view hidden-section">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end" id="top3Container">
                <p class="col-span-3 text-center text-gray-400 italic py-10">Selecciona filtros y consulta para ver resultados.</p>
            </div>
        </div>

        <div id="view-global" class="report-view hidden-section">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                        <tr><th class="p-4">#</th><th class="p-4">Equipo</th><th class="p-4">Escuela</th><th class="p-4 text-right">Puntaje</th></tr>
                    </thead>
                    <tbody id="tablaGlobalBody" class="text-sm divide-y divide-gray-100"></tbody>
                </table>
                <div id="globalEmpty" class="p-8 text-center text-gray-400 italic">Sin datos</div>
            </div>
        </div>

        <div id="view-equipos" class="report-view hidden-section">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                        <tr><th class="p-3">Equipo</th><th class="p-3">Coach</th><th class="p-3">Escuela</th><th class="p-3">Estado</th></tr>
                    </thead>
                    <tbody id="tablaEquiposBody" class="text-sm divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div id="view-stats" class="report-view hidden-section">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold mb-4 text-gray-700">Participaci√≥n por Evento</h3>
                    <div id="statsContainer" class="space-y-4"></div>
                </div>
                <div class="bg-gradient-to-br from-[#5852CB] to-indigo-600 rounded-lg shadow p-6 text-white flex flex-col justify-center items-center text-center">
                    <i class="fa-solid fa-chart-simple text-5xl mb-4 opacity-50"></i>
                    <h3 class="text-lg font-bold">Resumen General</h3>
                    <p class="text-sm opacity-80">Seleccione un evento espec√≠fico para m√©tricas detalladas.</p>
                </div>
            </div>
        </div>

        <div id="view-detalle" class="report-view hidden-section">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <label class="font-bold text-sm text-gray-700 mr-2">Selecciona tu equipo:</label>
                <select id="misEquiposSelect" onchange="cargarDetalleEquipo()" class="border p-2 rounded bg-gray-50 outline-none focus:ring-2 focus:ring-[#5852CB]">
                    <option value="">-- Seleccionar --</option>
                </select>
            </div>
            
            <div id="detalleResult" class="hidden animate-fade-in">
                <div class="bg-white p-8 rounded-lg shadow border-t-4 border-[#5852CB]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b pb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-1" id="detNombre">--</h2>
                            <div class="flex gap-4 text-sm text-gray-500">
                                <span><i class="fa-solid fa-user-tie"></i> Juez: <span id="detJuez">--</span></span>
                                <span><i class="fa-regular fa-calendar"></i> <span id="detFecha">--</span></span>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 text-center bg-gray-50 p-4 rounded-xl">
                            <p class="text-xs text-gray-400 uppercase font-bold tracking-widest">Puntaje Final</p>
                            <p class="text-5xl font-bold text-[#5852CB]" id="detTotal">0</p>
                        </div>
                    </div>
                    
                    <h4 class="font-bold text-gray-600 mb-4 uppercase text-xs tracking-wider">Desglose de Criterios</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="detCriterios">
                        </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        let userRole = ''; 
        let currentTab = 'global';
        const API = '../Configuracion/reportes_controlador.php';

        document.addEventListener('DOMContentLoaded', async () => {
            await detectarRol();
            await cargarCatalogos();
            setupUI();
        });

        async function detectarRol() {
            try {
                const res = await fetch(`${API}?action=get_session_role`);
                const json = await res.json();
                if(json.success) userRole = json.role; 
            } catch(e) { console.error(e); }
            
            document.getElementById('userRoleDisplay').innerText = userRole || 'INVITADO';
        }

        async function cargarCatalogos() {
            try {
                // CORRECCI√ìN: Ahora llamamos a 'reportes_controlador.php' en lugar de 'promover_juez.php'
                // Esto permite que Jueces y Coaches puedan ver la lista sin ser bloqueados.
                const res = await fetch('../Configuracion/reportes_controlador.php?action=obtener_catalogos');
                const data = await res.json();
                
                if(data.success) {
                    const selEv = document.getElementById('selectEvento');
                    const selCat = document.getElementById('selectCategoria');
                    
                    // Limpiamos antes de llenar para evitar duplicados si se llama dos veces
                    selEv.innerHTML = '<option value="">-- Seleccionar --</option>';
                    selCat.innerHTML = '<option value="">-- Seleccionar --</option>';

                    data.eventos.forEach(e => selEv.innerHTML += `<option value="${e.id_evento}">${e.nombre_evento}</option>`);
                    data.categorias.forEach(c => selCat.innerHTML += `<option value="${c.id_categoria}">${c.nombre_categoria}</option>`);
                }
            } catch(e) { console.error("Error cat√°logos", e); }
        }

        function setupUI() {
            // Mostrar tabs seg√∫n rol
            if(userRole === 'ADMIN') {
                document.querySelectorAll('.role-admin').forEach(el => el.classList.remove('hidden-section'));
                switchTab('stats'); 
                cargarStats(); // Carga inicial para admin
            } 
            else if (userRole === 'COACH' || userRole === 'COACH_JUEZ') {
                document.querySelectorAll('.role-coach').forEach(el => el.classList.remove('hidden-section'));
                switchTab('global');
                cargarMisEquiposCombo();
            } 
            else {
                // JUEZ
                switchTab('global');
            }
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Estilos Tabs
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            
            // Mostrar Vista
            document.querySelectorAll('.report-view').forEach(v => v.classList.add('hidden-section'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden-section');

            // Manejo de Filtros (Ocultar filtros en stats y detalle)
            const filtros = document.getElementById('filtrosGlobales');
            if(tabName === 'stats' || tabName === 'detalle') filtros.classList.add('hidden-section');
            else filtros.classList.remove('hidden-section');
        }

        function cargarReporteActual() {
            const ev = document.getElementById('selectEvento').value;
            const cat = document.getElementById('selectCategoria').value;
            if(!ev || !cat) return alert("Seleccione Evento y Categor√≠a");

            if (currentTab === 'top3') fetchData('admin_top3', renderTop3, ev, cat);
            else if (currentTab === 'global') fetchData('tabla_global', renderGlobal, ev, cat);
            else if (currentTab === 'equipos') fetchData('admin_lista_equipos', renderEquipos, ev, cat);
        }

        async function fetchData(action, renderFn, ev, cat) {
            try {
                const res = await fetch(`${API}?action=${action}&id_evento=${ev}&id_categoria=${cat}`);
                const json = await res.json();
                renderFn(json.data);
            } catch(e) { console.error(e); }
        }

        // --- RENDERS ---
        function renderTop3(data) {
            const cont = document.getElementById('top3Container');
            cont.innerHTML = '';
            
            if(!data || data.length === 0) {
                cont.innerHTML = '<div class="col-span-3 text-center text-gray-400">No hay ganadores calculados a√∫n.</div>';
                return;
            }

            // Orden visual: Plata (izq), Oro (centro-arriba), Bronce (der)
            // Simplemente listamos ordenado
            const icons = ['üëë', 'ü•à', 'ü•â'];
            const colors = ['border-yellow-400 bg-yellow-50', 'border-gray-300 bg-gray-50', 'border-orange-300 bg-orange-50'];

            data.forEach((item, i) => {
                const card = document.createElement('div');
                card.className = `p-6 rounded-xl border-t-8 shadow-md text-center transform hover:-translate-y-1 transition ${colors[i] || 'bg-white'}`;
                card.innerHTML = `
                    <div class="text-4xl mb-2">${icons[i] || `#${i+1}`}</div>
                    <h3 class="font-bold text-xl text-gray-800">${item.nombre_equipo}</h3>
                    <p class="text-sm text-gray-600 mb-2">${item.escuela_procedencia}</p>
                    <div class="inline-block bg-white px-4 py-1 rounded-full border border-gray-200 font-bold text-[#5852CB]">
                        ${item.puntaje} Pts
                    </div>
                `;
                cont.appendChild(card);
            });
        }

        function renderGlobal(data) {
            const tbody = document.getElementById('tablaGlobalBody');
            tbody.innerHTML = '';
            document.getElementById('globalEmpty').style.display = (data && data.length) ? 'none' : 'block';

            if(data) {
                data.forEach((r, i) => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b last:border-0">
                            <td class="p-4 font-bold text-gray-400">${i+1}</td>
                            <td class="p-4 font-bold text-gray-700">${r.nombre_equipo}</td>
                            <td class="p-4 text-gray-500 text-sm">${r.escuela_procedencia}</td>
                            <td class="p-4 text-right font-mono font-bold text-[#5852CB]">${r.puntaje_final}</td>
                        </tr>
                    `;
                });
            }
        }

        function renderEquipos(data) {
            const tbody = document.getElementById('tablaEquiposBody');
            tbody.innerHTML = '';
            if(data) {
                data.forEach(r => {
                    const badge = r.estado_proyecto === 'EVALUADO' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="p-3 font-medium text-gray-800">${r.nombre_equipo}</td>
                            <td class="p-3 text-xs text-gray-500">${r.nombre_coach}</td>
                            <td class="p-3 text-xs text-gray-500">${r.escuela_procedencia}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${badge}">${r.estado_proyecto}</span></td>
                        </tr>
                    `;
                });
            }
        }

        async function cargarStats() {
            const res = await fetch(`${API}?action=admin_estadisticas`);
            const json = await res.json();
            const cont = document.getElementById('statsContainer');
            cont.innerHTML = '';
            
            if(json.data) {
                json.data.forEach(s => {
                    const p = s.total_equipos > 0 ? Math.round((s.equipos_evaluados / s.total_equipos)*100) : 0;
                    cont.innerHTML += `
                        <div class="flex items-center justify-between border-b border-gray-100 pb-3 last:border-0">
                            <div>
                                <p class="font-bold text-gray-800">${s.nombre_evento}</p>
                                <p class="text-xs text-gray-400">Total Equipos: ${s.total_equipos}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-bold text-[#5852CB]">${p}%</span>
                                <p class="text-[10px] text-gray-400">Evaluados</p>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- COACH LOGIC ---
        async function cargarMisEquiposCombo() {
            const res = await fetch(`${API}?action=mis_equipos_evaluados`);
            const json = await res.json();
            const sel = document.getElementById('misEquiposSelect');
            if(json.success && json.data) {
                json.data.forEach(e => sel.innerHTML += `<option value="${e.id_equipo}">${e.nombre_equipo}</option>`);
            }
        }

        async function cargarDetalleEquipo() {
            const id = document.getElementById('misEquiposSelect').value;
            if(!id) return;

            const res = await fetch(`${API}?action=detalle_mi_equipo&id_equipo=${id}`);
            const json = await res.json();

            if(json.success) {
                const d = json.data;
                document.getElementById('detalleResult').classList.remove('hidden');
                document.getElementById('detNombre').innerText = d.nombre_equipo;
                document.getElementById('detJuez').innerText = d.nombre_juez;
                document.getElementById('detFecha').innerText = d.fecha_evaluacion;
                document.getElementById('detTotal').innerText = d.puntuacion_total;

                const cont = document.getElementById('detCriterios');
                cont.innerHTML = '';
                const criterios = JSON.parse(d.detalles_evaluacion || '{}');

                for (const [k, v] of Object.entries(criterios)) {
                    // Mejora visual: Reemplazar _ por espacio y Capitalizar
                    const label = k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const status = v ? '<span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> Cumple</span>' : '<span class="text-red-400 italic"><i class="fa-solid fa-xmark"></i> No Cumple</span>';
                    
                    cont.innerHTML += `
                        <div class="flex justify-between items-center p-3 border rounded bg-gray-50">
                            <span class="text-xs font-medium text-gray-700">${label}</span>
                            ${status}
                        </div>
                    `;
                }
            } else {
                alert(json.message);
            }
        }
    </script>
</body>
</html>